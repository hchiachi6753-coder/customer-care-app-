# Changelog

All notable changes to this project will be documented in this file.

## [1.0.0] - 2024-12-19

### Added
- **初始版本發布**
  - 完整的客戶關懷管理系統
  - Salesforce Lightning 風格的 UI 設計
  - 移動優先的響應式設計

### Features
- **主控台 (Dashboard)**
  - 三階段任務分組：新手關懷、首課關懷、一般關懷
  - 嚴格的日期過濾（只顯示今日及逾期任務）
  - F-Pattern 佈局設計
  - 點擊導航到客戶詳情頁

- **合約管理**
  - 新增合約表單，包含 CRM 欄位（email, lineId, parentName, product）
  - 動態日期依賴關係
  - 表單驗證和錯誤處理

- **客戶詳情頁**
  - 完整的客戶聯絡資訊
  - 整合關懷歷史時間軸
  - 視覺化任務狀態指示器
  - 垂直時間軸設計，包含日期徽章和狀態點

- **自動任務生成系統**
  - Firebase Cloud Functions 觸發器
  - 每個合約自動生成 26 個任務（2個關懷任務 + 24個月度任務）
  - 資料反正規化策略，避免 N+1 查詢問題

### Technical Implementation
- **前端**: Next.js 14+ (App Router), TypeScript, Tailwind CSS
- **後端**: Firebase (Firestore, Cloud Functions v2)
- **部署**: Vercel (前端) + Firebase (雲函數)
- **UI 組件**: Lucide React 圖標
- **狀態管理**: React Context + Hooks

### Database Schema
- **contracts**: 核心客戶資料，包含 noviceDate 和 firstLessonDate 手動輸入欄位
- **tasks**: 自動生成的關懷任務，包含反正規化欄位（clientName, parentName, product）
- **taskLogs**: 任務執行記錄

### Key Architectural Decisions
- **資料策略**: 實施反正規化模式，在 Task 文檔中儲存 clientName, parentName, product
- **日期邏輯**: 使用合約中的手動 noviceDate 和 firstLessonDate，而非計算的 T+0 日期
- **UI 模式**: 採用 Salesforce Lightning 設計系統，slate-50 背景，白色卡片，彩色左邊框
- **導航模式**: 實施點擊導航模式（非直接撥號）從控制台卡片到客戶詳情頁

### Deployment Configuration
- **成功部署到 Vercel**（前端）和 Firebase（雲函數）
- **環境變數配置**: 正確的 Firebase 配置
- **Next.js 配置**: 啟用 Turbopack 並排除 /functions 目錄

---

## [1.1.0] - 2024-12-20

### Added
- **任務完成模態框 (TaskCompletionModal)**
  - 動態通話狀態選擇（成功聯繫、未接聽、忙線中）
  - 智能日期邏輯：成功時選填，失敗時必填
  - 紅色警示樣式用於重新排程模式
  - 自定義日期選擇器解決瀏覽器兼容性問題
  - **行程預覽卡片**：顯示「下一次系統排程」和「手動預約任務」
  - **智慧過濾**：預覽列表自動截斷到最近的系統任務
  - **欄位簡化**：移除插入行程開關，改為常駐日期欄位
  - **動態提示**：根據通話狀態改變日期欄位標題

### Enhanced
- **任務處理邏輯優化**
  - 實施嚴格的結果邏輯：完成 vs 重新排程
  - 成功聯繫：標記完成 + 可選建立新任務
  - 失敗聯繫：保持開啟 + 重新排程到新日期
  - 日期格式標準化（統一使用斜線格式）

- **UX 改善**
  - 解決「隱形任務」bug（日期格式問題）
  - 成功聯繫時日期欄位真正空白，避免使用者困惑
  - 動態標籤和樣式根據通話結果調整
  - 強制重新渲染機制確保狀態正確更新

### Fixed
- **日期處理 Bug 修正**
  - 修正重新排程後任務消失的問題
  - 確保備註和通話記錄正確儲存
  - 解決瀏覽器日期輸入框無法清空的問題
  - 實施自定義日期選擇器避免預設值顯示
  - **日期格式統一**：修復 HTML (YYYY-MM-DD) 與 Firestore (YYYY/MM/DD) 格式不符問題
  - **系統任務識別**：增強識別邏輯，檢查標題關鍵字（月度、首課、新手）

### Technical Improvements
- **狀態管理優化**
  - 移除衝突的 useEffect 邏輯
  - 實施專用的 handleOutcomeChange 處理函數
  - 使用 key 屬性強制組件重新渲染
  - 改善模態框重置邏輯

---

## [1.2.0] - 2024-12-20

### Added
- **四欄位看板佈局 (4-Column Kanban Board)**
  - 將原本的3欄改為4欄：新手關懷、首課關懷、月度關懷、一般關懷
  - 明確區分系統生成任務 vs 手動建立任務
  - 新增月度關懷欄位（紫色主題 + 🗓️ 圖標）
  - 一般關懷改為手動任務專用（橙色主題 + 📋 圖標）

- **客戶列表時間軸分組 (Timeline Grouped Client List)**
  - 按合約起始日期分組顯示（YYYY年 MM月）
  - 分組標題顯示客戶數量統計
  - 未設定日期的客戶歸類到底部
  - 單行緊湊佈局：學員姓名 + (家長：姓名) + 產品狀態 + 日期

### Enhanced
- **視覺優化與排序邏輯**
  - 客戶列表標題加深背景色（slate-200）並增大字體
  - 客戶行高減少30%，使用邊框分隔取代間距
  - 實施二級排序：主要按日期，次要按建檔時間
  - 客戶列表：最新合約優先，同日內最晚建檔優先
  - 關懷歷程：最早任務優先，同日內系統任務優先

- **關懷歷程完整性修復**
  - 確保手動建立的一般關懷任務顯示在時間軸中
  - 新增一般關懷（手動）類型：📞 圖標 + 橙色主題
  - 區分系統月度關懷 vs 手動一般關懷
  - 完整的任務類型支援和視覺識別

### Fixed
- **任務分類邏輯優化**
  - 修正月度關懷和一般關懷的過濾條件
  - 使用 `isSystemGenerated` 標記區分任務來源
  - 確保所有任務類型都能正確顯示和分類

### UI/UX Improvements
- **緊湊化設計**
  - 客戶列表採用單行佈局，資訊密度提升
  - 優化間距和視覺層次，提升掃描效率
  - 響應式文字截斷，避免版面破壞

### Technical Enhancements
- **穩定排序算法**
  - 實施多層級排序邏輯避免排序不穩定
  - 處理邊界情況（缺失日期、建檔時間）
  - 確保業務邏輯一致性（系統任務優先於手動任務）

---

## [1.2.1] - 2024-12-20

### Fixed
- **TypeScript 編譯錯誤修復**
  - 在 Contract 和 Task 介面中新增 `createdAt?: Timestamp` 欄位
  - 在 TaskStatus 類型中新增 `'todo'` 狀態支援
  - 修正 allContractTasks 的類型轉換問題
  - 確保所有 TypeScript 類型檢查通過

### Changed
- **UI 調整**
  - 移除客戶列表標題中的版本標示 (v2.0)
  - 清理不必要的版本資訊顯示

### Technical
- **部署準備**
  - 解決所有編譯時期錯誤
  - 確保專案可以成功建置和部署
  - 完成生產環境準備

---

## [2.0.0-spec] - 2024-12-20

### 📋 **系統規格更新 - 權限與組織管理模組**

#### **新增模組規劃**
- **帳號驗證系統**：Email/Password 或 Google Workspace SSO
- **角色權限管理 (RBAC)**：三層權限架構（銷售/主管/總監）
- **管理儀表板**：階層式資料檢視與操作介面

#### **權限矩陣設計**
- **Sales（銷售人員）**：僅限個人資料存取
- **Manager（銷售主管）**：團隊範圍資料管理
- **Director（銷售總監）**：全公司資料總覽

#### **管理視角架構**
- **個人視角**：待辦事項看板
- **團隊視角**：人員卡片 + 鑽取檢視 + 全團隊展開
- **組織視角**：團隊總覽 + 多層級鑽取 + 全公司展開

#### **資料庫查詢規則**
- 嚴格的權限過濾條件
- 基於 `ownerId` 和 `teamId` 的資料隔離
- 效能優化的查詢策略

#### **技術規格文件**
- 完整的 RBAC 實作規範
- 使用者介面設計指引
- 資料庫架構更新說明
- **安全性實作**：Firestore Security Rules 和 API 驗證
- **UI/UX 設計**：角色導航、權限錯誤處理、團隊切換
- **效能優化**：分頁策略、快取機制、索引設計
- **部署管理**：環境設定、初始化流程、使用者入籍
- **審計日誌**：活動記錄、存取監控、GDPR 合規

*註：此版本為規格設計階段，實作功能將在後續版本中推出*

---

## [2.1.0-spec] - 2024-12-20

### 📋 **技術規格補充 - 實作細節與優化**

#### **資料庫架構更新**
- **RBAC 欄位擴充**：所有業務集合新增 `ownerId`, `teamId`, `updatedBy`, `lastModified`
- **資料遷移策略**：既有資料的一次性遷移腳本和預設歸屬邏輯
- **複合索引設計**：針對多條件查詢的效能優化索引配置

#### **安全性規則強化**
- **增強版 Firestore Rules**：防止惡意 API 呼叫的後端強制驗證
- **寫入權限控制**：禁止非授權修改 `ownerId` 和 `teamId`
- **審計日誌保護**：系統操作記錄的存取權限管理

#### **UI/UX 實作規範**
- **動態導航系統**：基於角色的選單差異化渲染
- **團隊切換組件**：下拉選單式的團隊切換介面
- **權限錯誤處理**：403 頁面和保護路由組件設計

#### **效能與擴展性**
- **無限捲動分頁**：大數據集的漸進式載入策略
- **快取層級優化**：多層次快取機制設計
- **索引配置完整化**：生產環境就緒的複合索引定義

#### **部署與維運**
- **初始化腳本增強**：自動化管理員帳號建立流程
- **環境隔離策略**：開發/測試/生產的權限分離
- **使用者入籍流程**：完整的帳號建立和權限分配機制

#### **審計與合規強化**
- **增強版活動日誌**：詳細的操作前後狀態記錄
- **審計服務類別**：統一的日誌記錄介面和方法
- **敏感操作追蹤**：客戶調撥、合約修改等關鍵操作監控

*註：此版本為 v2.0 規格的實作細節補充，提供完整的開發指引*

---

## [2.2.0] - 2024-12-20

### 🚀 **Phase 3 & 4 實作完成 - RBAC 權限與團隊管理系統**

#### **✅ Phase 3: 權限過濾器 (RBAC Data Filter)**
- **實作檔案**: `app/page.tsx`
- **權限邏輯實作**:
  - **Sales (業務)**: `where('ownerId', '==', user.uid)` - 僅讀取自己的客戶
  - **Manager (主管)**: `where('teamId', '==', userProfile.teamId)` - 讀取同團隊所有成員的客戶
  - **Director (總監)**: `fetch all` - 無條件讀取全公司資料
- **狀態**: ✅ 已實裝並測試通過

#### **✅ Phase 4: 後端引擎與 API (Backend Infrastructure)**
- **核心技術**: 導入 `firebase-admin` SDK (Server-side)
- **API 路徑**: `app/api/admin/create-user/route.ts`
- **功能特色**:
  - 雙重寫入：同時建立 Authentication 帳號與 Firestore 使用者檔案
  - 防呆機制：自動檢查 Email 重複、密碼長度
  - Singleton 模式：防止 Next.js 熱重載時造成 Admin SDK 重複初始化崩潰
- **環境變數新增**:
  - `FIREBASE_PROJECT_ID`: `customer-care-v1`
  - `FIREBASE_CLIENT_EMAIL`: `firebase-adminsdk-fbsvc@customer-care-v1.iam.gserviceaccount.com`
  - `FIREBASE_PRIVATE_KEY`: 完整私鑰配置
  - 解決 Vercel 環境下私鑰換行符號 (`\n`) 的解析問題

### 👥 **團隊管理後台 (Team Management Dashboard)**
- **實作檔案**: `app/admin/team/page.tsx`
- **權限保護**: 僅限 `role === 'director'` 進入，其他人自動重導向首頁
- **新增成員表單**:
  - 支援姓名、Email、密碼、角色、團隊設定
  - 固定團隊選單 (Team 1 ~ Team 5) 防止輸入錯誤
  - 前端密碼長度檢查 (至少 6 碼)
- **成員列表功能**:
  - 從 Firestore `users` 集合讀取所有用戶
  - 按建立時間降序排列
  - 角色標籤顏色區分 (總監/主管/業務)
  - 團隊名稱友善顯示
  - 即時更新：新增成功後自動刷新列表

### 🎨 **UI/UX 優化與手機版適配**
- **實作檔案**: `components/Navbar.tsx`
- **導航列優化**:
  - **品牌按鈕化**: 左上角 Logo 改為淡藍色按鈕樣式 + 🏠 房子圖示
  - **手機版精簡**: 隱藏過長招呼語，僅保留姓名與圖示
  - **響應式設計**: 優化按鈕間距與排版，防止擁擠
  - **視覺回饋**: 加入 Hover 效果與縮放動畫
- **團隊管理按鈕**:
  - 紫色主題突出管理功能
  - 手機版僅顯示齒輪圖示，桌面版顯示完整文字
  - 僅對總監角色顯示

### ☁️ **部署配置 (Deployment)**
- **平台**: Vercel
- **環境變數設定**: 修正 `FIREBASE_PRIVATE_KEY` 在 Vercel 介面上的格式問題
- **網域授權**: Firebase Console 將 Vercel 網域加入白名單
- **驗收結果**: 線上版功能運作正常，API 呼叫成功

### 🔧 **技術改進**
- **AuthContext 更新**: 支援 `profile` 物件存取用戶角色資訊
- **ProtectedRoute 組件**: 統一的路由保護機制
- **錯誤處理**: 完善的 API 錯誤處理和用戶反饋
- **狀態管理**: 分離表單提交和列表載入狀態
- **類型安全**: 完整的 TypeScript 類型定義

### 📊 **資料庫架構**
- **users 集合**: 儲存用戶基本資料、角色、團隊歸屬
- **權限欄位**: `role` (sales/manager/director), `teamId`, `createdAt`
- **查詢優化**: 基於角色的條件查詢，確保資料隔離

---

## Future Releases

### Planned Features
- 任務完成狀態更新
- 客戶搜索和篩選功能
- 報表和分析功能
- 通知系統
- 批量操作功能

### Technical Improvements
- 性能優化
- 離線支援
- 更多的測試覆蓋率
- 國際化支援