# 系統技術規格書 (New Spec V2 - 2025/12/22)

## 1. 系統定位與目標
本系統專為銷售業務、業務主管及總監設計，核心目標是自動化管理「成交後」的客戶關懷流程。確保從合約開始的前八個月內，業務能按照公司要求的頻率進行高品質的客戶互動。

## 2. 核心技術架構
- **前端框架**: Next.js (App Router)
- **樣式處理**: Tailwind CSS (含四大板塊色彩與斑馬紋規範)
- **後端服務**: Firebase (Auth & Firestore)
- **權限管理**: 基於角色的訪問控制 (RBAC)

## 3. 資料庫結構 (Firestore Collections)

### users (使用者帳號)
- `uid`: Firebase Auth ID
- `name`: 姓名
- `email`: 電子郵件
- `role`: director (總監) / manager (主管) / sales (業務)
- `teamId`: 所屬團隊 ID (例如 main_team, team_a)

### contracts (客戶合約)
- `id`: 合約 ID
- `ownerId`: 負責業務 UID
- `teamId`: 所屬團隊 ID
- `clientName`: 客戶姓名
- `startDate`: 合約起始日 (Timestamp)
- `isHighRenewal`: boolean (高續約標記)
- `isHighMGM`: boolean (高推薦標記)

### tasks (關懷任務)
- `contractId`: 關聯的合約 ID
- `taskType`: newbie (新手) / first_class (首課) / system (系統) / general (一般)
- `status`: pending / completed
- `dueDate`: 預計關懷日 (Timestamp)
- `completedAt`: 實際完成日 (Timestamp)
- `contactStatus`: success / busy / missed
- `feedback`: none (無特別反饋) / issue (反應問題)
- `issueCategory`: teacher / material / system / service (反應問題子項)
- `content`: 溝通內容文字紀錄
- `nextGeneralDate`: 下次一般關懷日期 (可選)

### 4. 合約表單欄位規範 (Contract Form Fields)
所有標註 * 之欄位為必填項。

| 欄位名稱 | 型態 | 內容選項 / 備註 |
| :--- | :--- | :--- |
| **家長姓名 \*** | 文字 | |
| **學員姓名 \*** | 文字 | |
| **聯絡電話 \*** | 數字/文字 | |
| **Email** | 文字 | |
| **Line ID** | 文字 | |
| **合約性質** | 下拉選單 | 新約、續約 |
| **購買產品** | 下拉選單 | 升級包、勤學包、大拍檔、小拍檔、升級包副約、大排檔副約 |
| **付款方式** | 下拉選單 | 一次付清、分期付款 |
| **來源** | 下拉選單 | 行銷單、MGM(舊生介紹)、業務自建、結案單 |
| **合約起始日 \*** | 日期 (T=0) | 影響 8 筆任務的計算基準 |
| **新手關懷日 \*** | 日期 | 業務自訂 |
| **首課關懷日 \*** | 日期 | 預設 T+7，可修改 |
| **備註** | 長文字 | |

## 4. 關鍵業務邏輯 (Business Logic)

### A. 八筆自動預排任務 (Automated Scheduling)
新增合約時，系統必須同時寫入以下 8 筆任務：
1. **新手關懷**: 業務自訂日期。
2. **首課關懷**: 預設合約起始日 +7 天 (可改)。
3. **系統推播 (前2個月)**: 3 次 (均分於第 20, 40, 60 天)。
4. **系統推播 (3-8個月)**: 3 次 (均分於第 120, 180, 240 天)。

### B. 歷程狀態與顏色邏輯 (State Colors)
- **已完成 (綠色)**: 準時完成 (completedAt ≤ dueDate)。
- **逾期已完成 (橘色)**: 晚於預計時間完成 (completedAt > dueDate)。
- **逾期 (紅色)**: 當前時間 > dueDate 且未完成。
- **預計關懷 (藍色)**: 當前時間 < dueDate 且未完成。

## 5. UI/UX 視覺規範

### A. 待辦列表 (Dashboard)
**四大板塊**:
- **新手關懷**: 淺藍背景 (bg-blue-50) + 藍邊框。
- **首課關懷**: 淺紫背景 (bg-purple-50) + 紫邊框。
- **系統推播**: 淺綠背景 (bg-green-50) + 綠邊框。
- **一般關懷**: 淺橘背景 (bg-amber-50) + 橘邊框。

**篩選器**: 今日 (預設)、未來 3 天、一週、一個月。

### B. 客戶列表 (Customer List)
- **分類**: 依 startDate 月份進行分區塊顯示。
- **列表樣式**: 採用斑馬紋 (Zebra Striping) 區分客戶行。

## 6. 權限流程 (RBAC Flow)
- **總監**: 擁有「成員管理」功能。可新增 Email/密碼、設定身分與團隊。
- **登入**: 第一頁為登入頁，驗證身分後進入對應權限的首頁。
- **資料範圍**:
  - 業務看個人任務。
  - 主管看團隊任務。
  - 總監看全公司任務。